<?xml version="1.0" encoding="UTF-8"?>
<modification>
	<id>Opencart Ratings of store</id>
	<version>1.5.2</version>
	<author><a href="mailto:d.beerluskony@gmail.com">d.beerluskony@gmail.com</a></author>
	<file name="admin/view/template/common/header.tpl">
		<operation>
			<search position="before"><![CDATA[<li><a href="<?php echo $review; ?>"><?php echo $text_review; ?></a></li>]]></search>
			<add><![CDATA[
				<li><a href="<?php echo $shop_rating; ?>"><?php echo $text_shop_rating; ?></a></li>
			]]>
			</add>
		</operation>
	</file>
	<file name="admin/controller/common/header.php">
		<operation>
			<search position="after"><![CDATA[$this->data['text_review'] = $this->language->get('text_review');]]></search>
			<add><![CDATA[
				$this->load->language('catalog/shop_rating');
				$this->data['text_shop_rating'] = $this->language->get('text_shop_rating');
			]]>
			</add>
		</operation>
		<operation>
			<search position="after"><![CDATA[$this->data['review'] = $this->url->link('catalog/review', 'token=' . $this->session->data['token'], 'SSL');]]></search>
			<add><![CDATA[
				$this->data['shop_rating'] = $this->url->link('catalog/shop_rating', 'token=' . $this->session->data['token'], 'SSL');
			]]>
			</add>
		</operation>
	</file>
	<file name="catalog/controller/feed/google_sitemap.php">
		<operation>
			<search position="before"><![CDATA[$output .= '</urlset>';]]></search>
			<add><![CDATA[

				/*------ShopRating------*/

				$output .= '<url>';
				$output .= '<loc>' . $this->url->link('information/shop_rating') . '</loc>';
				$output .= '<changefreq>weekly</changefreq>';
				$output .= '<priority>0.5</priority>';
				$output .= '</url>';

				/*----END ShopRating----*/

			]]>
			</add>
		</operation>
	</file>
	<file name="catalog/controller/information/sitemap.php">
		<operation>
			<search position="after"><![CDATA[$this->data['informations'] = array();]]></search>
			<add><![CDATA[

				/*------ShopRating------*/

				$this->load->language('information/shop_rating');
				$this->data['informations'][] = array(
					'title' => $this->language->get('sr_title'),
					'href'  => $this->url->link('information/shop_rating')
				);

				/*----END ShopRating----*/

			]]>
			</add>
		</operation>
	</file>
	<file name="admin/model/sale/order.php">
		<operation>
			<search position="before"><![CDATA[public function addOrderHistory($order_id, $data) {]]></search>
			<add><![CDATA[

				/*------ShopRating------*/

	public function request_mail($order_info) {

		$this->load->language('catalog/shop_rating');

		//$this->load->model('checkout/order');
		$this->load->model('catalog/shop_rating');

		//$order_info = $this->model_checkout_order->getOrder($order_id);
		$store_name = html_entity_decode($this->config->get('config_name'), ENT_QUOTES, 'UTF-8');
		$store_url = '<a href="'.$order_info['store_url'].'">'.$store_name.'</a>';
		$customer_name = $order_info['firstname'];
		//$ratings_link = '<a href="'.$this->url->link('information/shop_rating').'">"'.$this->language->get('sr_title').'"</a>';
		$ratings_link = '<a href="'.$order_info['store_url'].'?route=information/shop_rating'.'">"'.$this->language->get('sr_title').'"</a>';

		if(isset($order_info['customer_id']) && $order_info['customer_id'] > 0){
			$count = $this->model_catalog_shop_rating->customerRatingsCount($order_info['customer_id']);
			if($count && $count > 0){
				$send = false;
			}else{
				$send = true;
			}
		}else{
			$send = true;
		}

		if($order_info['order_status_id'] == $this->config->get('shop_rating_request_status') && $send == true) {


			if($this->config->get('shop_rating_request_subject')){
				$subject = html_entity_decode($this->config->get('shop_rating_request_subject'));
			}else{
				$subject = sprintf($this->language->get('text_request_mail_subject'), html_entity_decode($this->config->get('config_name'), ENT_QUOTES, 'UTF-8'));
			}

			if($this->config->get('shop_rating_request_text') && $this->config->get('shop_rating_request_text') != ''){
				$mail_text = html_entity_decode($this->config->get('shop_rating_request_text'), ENT_QUOTES, 'UTF-8');
			}else{
				$mail_text = html_entity_decode($this->language->get('text_request_mail_text'), ENT_QUOTES, 'UTF-8');
			}
			$mail_text = str_replace('[store_name]', $store_name, $mail_text);
			$mail_text = str_replace('[store_name_link]', $store_url, $mail_text);
			$mail_text = str_replace('[customer_name]', $customer_name, $mail_text);
			$mail_text = str_replace('[ratings_link]', $ratings_link, $mail_text);

			$message = '<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /></head>';

			$message .= $mail_text;
			$message .= '</body></html>';

			$mail = new Mail();
			$mail->protocol = $this->config->get('config_mail_protocol');
			$mail->parameter = $this->config->get('config_mail_parameter');
			$mail->smtp_hostname = $this->config->get('config_mail_smtp_hostname');
			$mail->smtp_username = $this->config->get('config_mail_smtp_username');
			$mail->smtp_password = html_entity_decode($this->config->get('config_mail_smtp_password'), ENT_QUOTES, 'UTF-8');
			$mail->smtp_port = $this->config->get('config_mail_smtp_port');
			$mail->smtp_timeout = $this->config->get('config_mail_smtp_timeout');


			$mail->setTo($order_info['email']);
			$mail->setFrom($this->config->get('config_email'));

			$mail->setSender(html_entity_decode($this->config->get('config_name'), ENT_QUOTES, 'UTF-8'));
			$mail->setSubject($subject);
			$mail->setHtml($message);
			$mail->setText(html_entity_decode($message, ENT_QUOTES, 'UTF-8'));
			$mail->send();

		}

	}

				/*----END ShopRating----*/

			]]>
			</add>
		</operation>
		<operation>
			<search position="before"><![CDATA[if ($data['notify']) {]]></search>
			<add><![CDATA[

				/*------ShopRating------*/

		$this->request_mail($order_info);

				/*----END ShopRating----*/

			]]>
			</add>
		</operation>
	</file>
</modification>