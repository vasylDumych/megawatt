<modification>
	<id><![CDATA[Series]]></id>
	<version><![CDATA[1.0.7]]></version>
	<vqmver><![CDATA[2.1.6]]></vqmver>
	<author><![CDATA[avot yoyo.dima@gmail.com]]></author>

	<file name="admin/controller/catalog/manufacturer.php">
		<operation>
			<search position="before" index="2"><![CDATA[if (!$this->error) {]]></search>
			<add><![CDATA[

				$this->load->model('catalog/series');
				
				foreach ($this->request->post['selected'] as $manufacturer_id) {
		  			$series_total = $this->model_catalog_series->getTotalSeriesByManufacturerId($manufacturer_id);
		    
					if ($series_total) {
			  			$this->error['warning'] = sprintf($this->language->get('error_series'), $series_total);	
					}	
			  	} 

			]]></add>
		</operation>	
	</file>

	<file name="admin/controller/catalog/product.php">
		<operation>
			<search position="after"><![CDATA[$this->data['entry_required'] = $this->language->get('entry_required');]]></search>
			<add><![CDATA[
				$this->data['entry_series'] = $this->language->get('entry_series');
			]]></add>
		</operation>

		<operation>
			<search position="before"><![CDATA[$this->load->model('catalog/category');]]></search>
			<add><![CDATA[

				if ($this->data['manufacturer_id'] != 0) {
					$this->load->model('catalog/series');
			    	$this->data['series'] = $this->model_catalog_series->getSeriesByManufacturerId($this->data['manufacturer_id']);
			    } else {
			    	$this->data['series'] = array();
			    }

			    if (isset($this->request->post['series_id'])) {
		      		$this->data['series_id'] = $this->request->post['series_id'];
				} elseif (!empty($product_info)) {
					$this->data['series_id'] = $product_info['series_id'];
				} else {
		      		$this->data['series_id'] = 0;
		    	}

			]]></add>
		</operation>	
	</file>

	<file name="admin/controller/common/home.php">
		<operation>
			<search position="after"><![CDATA[public function index() {]]></search>
			<add><![CDATA[
				$this->load->model('catalog/series');

				$this->model_catalog_series->checkSeries();
			]]></add>
		</operation>	
	</file>

	<file name="admin/controller/common/header.php">
		<operation>
			<search position="after"><![CDATA[$this->data['text_setting'] = $this->language->get('text_setting');]]></search>
			<add><![CDATA[
				$this->data['text_series'] = $this->language->get('text_series');
			]]></add>
		</operation>

		<operation>
			<search position="after"><![CDATA[$this->data['setting'] = $this->url->link('setting/store', 'token=' . $this->session->data['token'], 'SSL');]]></search>
			<add><![CDATA[
				$this->data['series'] = $this->url->link('catalog/series', 'token=' . $this->session->data['token'], 'SSL');
			]]></add>
		</operation>	
	</file>

	<file name="admin/language/russian/catalog/product.php">
		<operation>
			<search position="after"><![CDATA[$_['entry_required']]]></search>
			<add><![CDATA[
				$_['entry_series']         = 'Серия:';
			]]></add>
		</operation>	
	</file>

	<file name="admin/language/english/catalog/product.php">
		<operation>
			<search position="after"><![CDATA[$_['entry_required']]]></search>
			<add><![CDATA[
				$_['entry_series']         = 'Series:';
			]]></add>
		</operation>	
	</file>

	<file name="admin/language/russian/common/header.php">
		<operation>
			<search position="after"><![CDATA[$_['text_setting']]]></search>
			<add><![CDATA[
				$_['text_series']                     = 'Серии';
			]]></add>
		</operation>	
	</file>

	<file name="admin/language/english/common/header.php">
		<operation>
			<search position="after"><![CDATA[$_['text_setting']]]></search>
			<add><![CDATA[
				$_['text_series']                     = 'Series';
			]]></add>
		</operation>	
	</file>

	<file name="admin/model/catalog/product.php">
		<operation>
			<search position="before"><![CDATA[public function getTotalProductsByAttributeId($attribute_id) {]]></search>
			<add><![CDATA[
				public function getTotalProductsBySeriesId($series_id) {
					$query = $this->db->query("SELECT COUNT(*) AS total FROM " . DB_PREFIX . "product_to_series WHERE series_id = '" . (int)$series_id . "'");

					return $query->row['total'];
				}

			]]></add>
		</operation>

		<operation>
			<search position="before" index="1"><![CDATA[if (isset($data['image'])) {]]></search>
			<add><![CDATA[
				if (isset($data['series_id']) && $data['series_id'] != 0) {
					$this->db->query("INSERT INTO " . DB_PREFIX . "product_to_series SET product_id = '" . (int)$product_id . "', series_id = '" . (int)$data['series_id'] . "'");
				}
			]]></add>
		</operation>
		
		<operation>
			<search position="before" index="2"><![CDATA[if (isset($data['image'])) {]]></search>
			<add><![CDATA[
				$this->db->query("DELETE FROM " . DB_PREFIX . "product_to_series WHERE product_id = '" . (int)$product_id . "'");
				if (isset($data['series_id']) && $data['series_id'] != 0) {
					$this->db->query("INSERT INTO " . DB_PREFIX . "product_to_series SET product_id = '" . (int)$product_id . "', series_id = '" . (int)$data['series_id'] . "'");
				}
			]]></add>
		</operation>

		<operation>
			<search position="before" index="2"><![CDATA[$this->db->query("DELETE FROM " . DB_PREFIX . "product_to_store WHERE product_id = '" . (int)$product_id . "'");]]></search>
			<add><![CDATA[
				$this->db->query("DELETE FROM " . DB_PREFIX . "product_to_series WHERE product_id = '" . (int)$product_id . "'");
			]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[$query = $this->db->query("SELECT DISTINCT *, (SELECT keyword FROM " . DB_PREFIX . "url_alias WHERE query = 'product_id=" . (int)$product_id . "') AS keyword FROM " . DB_PREFIX . "product p LEFT JOIN " . DB_PREFIX . "product_description pd ON (p.product_id = pd.product_id) WHERE p.product_id = '" . (int)$product_id . "' AND pd.language_id = '" . (int)$this->config->get('config_language_id') . "'");]]></search>
			<add><![CDATA[
				$query = $this->db->query("SELECT DISTINCT *, (SELECT keyword FROM " . DB_PREFIX . "url_alias WHERE query = 'product_id=" . (int)$product_id . "') AS keyword FROM " . DB_PREFIX . "product p LEFT JOIN " . DB_PREFIX . "product_description pd ON (p.product_id = pd.product_id) LEFT JOIN " . DB_PREFIX . "product_to_series pts ON (p.product_id = pts.product_id) WHERE p.product_id = '" . (int)$product_id . "' AND pd.language_id = '" . (int)$this->config->get('config_language_id') . "'");
			]]></add>
		</operation>	
	</file>

	<file name="admin/view/template/catalog/product_form.tpl">
<!-- 		<operation>
			<search position="after" offset="11"><![CDATA[<td><?php echo $entry_manufacturer; ?></td>]]></search>
			<add><![CDATA[
				<tr>
	              <td><?php echo $entry_series; ?></td>
	              <td><select name="series_id">
	                <option value="0" selected="selected"><?php echo $text_none; ?></option>
	                <?php foreach ($series as $series_once) { ?>
	                <?php if ($series_once['series_id'] == $series_id) { ?>
	                <option value="<?php echo $series_once['series_id']; ?>" selected="selected"><?php echo $series_once['name']; ?></option>
	                <?php } else { ?>
	                <option value="<?php echo $series_once['series_id']; ?>"><?php echo $series_once['name']; ?></option>
	                <?php } ?>
	                <?php } ?>
	              </select></td>
	            </tr>
			]]></add>
		</operation> -->

		<operation>
			<search position="before"><![CDATA[<?php echo $footer; ?>]]></search>
			<add><![CDATA[
				<script type="text/javascript"><!--
				$('select[name=\'manufacturer_id\']').change(function(){
					manufacturer_id = $(this).val();
					$.ajax({
						url: 'index.php?route=catalog/series/serieslist&token=<?php echo $token; ?>&manufacturer_id=' + manufacturer_id,
						dataType: 'json',
						success: function(json) {
							$('select[name=\'series_id\']').html('');
							$('select[name=\'series_id\']').html('<option value="0" selected="selected"><?php echo $text_none; ?></option>');
							$.each(json, function(index, value){
								$('select[name=\'series_id\']').append('<option value="' + value.series_id + '">' + value.name + '</option>')
							})
						}
					});
				})
				//--></script> 
			]]></add>
		</operation>	
	</file>

	<!--<file name="admin/view/template/common/header.tpl">
		<operation>
			<search position="after"><![CDATA[<li><a href="<?php echo $manufacturer; ?>"><?php echo $text_manufacturer; ?></a></li>]]></search>
			<add><![CDATA[
				<li><a href="<?php echo $series; ?>"><?php echo $text_series; ?></a></li>
			]]></add>
		</operation>	
	</file>-->

	<file name="catalog/controller/common/seo_url.php">
		<operation>
			<search position="before"><![CDATA[if ($url[0] == 'information_id') {]]></search>
			<add><![CDATA[
				if ($url[0] == 'series_id') {
					$this->request->get['series_id'] = $url[1];
				}				
			]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA[if (($data['route'] == 'product/product' && $key == 'product_id') || (($data['route'] == 'product/manufacturer/info' || $data['route'] == 'product/product') && $key == 'manufacturer_id') || ($data['route'] == 'information/information' && $key == 'information_id')) {]]></search>
			<add><![CDATA[
				if (($data['route'] == 'product/product' && $key == 'product_id') || (($data['route'] == 'product/manufacturer/info' || $data['route'] == 'product/product') && $key == 'manufacturer_id') || ($data['route'] == 'product/manufacturer/info' && $key == 'series_id') || ($data['route'] == 'information/information' && $key == 'information_id')) {				
			]]></add>
		</operation>	
	</file>

	<file name="catalog/controller/product/manufacturer.php">
		<operation>
			<search position="after" index="2"><![CDATA[$url = '';]]></search>
			<add><![CDATA[
				$series_url = '';

				if (isset($this->request->get['series_id'])) {
					$series_url = '&series_id=' . $this->request->get['series_id'];
				}
			]]></add>
		</operation>

		<operation>
			<search position="after" index="3"><![CDATA[$url = '';]]></search>
			<add><![CDATA[

				if (isset($this->request->get['series_id'])) {
					$url .= '&series_id=' . $this->request->get['series_id'];
				}
			]]></add>
		</operation>

		<operation>
			<search position="after" index="4"><![CDATA[$url = '';]]></search>
			<add><![CDATA[

				if (isset($this->request->get['series_id'])) {
					$url .= '&series_id=' . $this->request->get['series_id'];
				}
			]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA['href'  => $this->url->link('product/manufacturer/info', 'manufacturer_id=' . $this->request->get['manufacturer_id'] . '&sort=p.sort_order&order=ASC' . $url)]]></search>
			<add><![CDATA[
				'href'  => $this->url->link('product/manufacturer/info', 'manufacturer_id=' . $this->request->get['manufacturer_id'] . $series_url . '&sort=p.sort_order&order=ASC' . $url)
			]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA['href'  => $this->url->link('product/manufacturer/info', 'manufacturer_id=' . $this->request->get['manufacturer_id'] . '&sort=pd.name&order=ASC' . $url)]]></search>
			<add><![CDATA[
				'href'  => $this->url->link('product/manufacturer/info', 'manufacturer_id=' . $this->request->get['manufacturer_id'] . $series_url . '&sort=pd.name&order=ASC' . $url)
			]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA['href'  => $this->url->link('product/manufacturer/info', 'manufacturer_id=' . $this->request->get['manufacturer_id'] . '&sort=pd.name&order=DESC' . $url)]]></search>
			<add><![CDATA[
				'href'  => $this->url->link('product/manufacturer/info', 'manufacturer_id=' . $this->request->get['manufacturer_id'] . $series_url . '&sort=pd.name&order=DESC' . $url)
			]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA['href'  => $this->url->link('product/manufacturer/info', 'manufacturer_id=' . $this->request->get['manufacturer_id'] . '&sort=p.price&order=ASC' . $url)]]></search>
			<add><![CDATA[
				'href'  => $this->url->link('product/manufacturer/info', 'manufacturer_id=' . $this->request->get['manufacturer_id'] . $series_url . '&sort=p.price&order=ASC' . $url)
			]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA['href'  => $this->url->link('product/manufacturer/info', 'manufacturer_id=' . $this->request->get['manufacturer_id'] . '&sort=p.price&order=DESC' . $url)]]></search>
			<add><![CDATA[
				'href'  => $this->url->link('product/manufacturer/info', 'manufacturer_id=' . $this->request->get['manufacturer_id'] . $series_url . '&sort=p.price&order=DESC' . $url)
			]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA['href'  => $this->url->link('product/manufacturer/info', 'manufacturer_id=' . $this->request->get['manufacturer_id'] . '&sort=rating&order=ASC' . $url)]]></search>
			<add><![CDATA[
				'href'  => $this->url->link('product/manufacturer/info', 'manufacturer_id=' . $this->request->get['manufacturer_id'] . $series_url . '&sort=rating&order=ASC' . $url)
			]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA['href'  => $this->url->link('product/manufacturer/info', 'manufacturer_id=' . $this->request->get['manufacturer_id'] . '&sort=rating&order=DESC' . $url)]]></search>
			<add><![CDATA[
				'href'  => $this->url->link('product/manufacturer/info', 'manufacturer_id=' . $this->request->get['manufacturer_id'] . $series_url . '&sort=rating&order=DESC' . $url)
			]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA['href'  => $this->url->link('product/manufacturer/info', 'manufacturer_id=' . $this->request->get['manufacturer_id'] . '&sort=p.model&order=ASC' . $url)]]></search>
			<add><![CDATA[
				'href'  => $this->url->link('product/manufacturer/info', 'manufacturer_id=' . $this->request->get['manufacturer_id'] . $series_url . '&sort=p.model&order=ASC' . $url)
			]]></add>
		</operation>

		<operation>
			<search position="replace"><![CDATA['href'  => $this->url->link('product/manufacturer/info', 'manufacturer_id=' . $this->request->get['manufacturer_id'] . '&sort=p.model&order=DESC' . $url)]]></search>
			<add><![CDATA[
				'href'  => $this->url->link('product/manufacturer/info', 'manufacturer_id=' . $this->request->get['manufacturer_id'] . $series_url . '&sort=p.model&order=DESC' . $url)
			]]></add>
		</operation>

		<operation>
			<search position="after"><![CDATA[$this->data['text_limit'] = $this->language->get('text_limit');]]></search>
			<add><![CDATA[
				$this->data['text_series'] = $this->language->get('text_series');
			]]></add>
		</operation>

		<operation>
			<search position="before" index="1"><![CDATA[if (isset($this->request->get['sort'])) {]]></search>
			<add><![CDATA[
				$this->load->model('catalog/series');

				if (isset($this->request->get['series_id'])) {
					$series_id = $this->request->get['series_id'];
				} else {
					$series_id = 0;
				}
			]]></add>
		</operation>

		<operation>
			<search position="after"><![CDATA[if ($manufacturer_info) {]]></search>
			<add><![CDATA[
				if ($series_id) {
					$series_info = $this->model_catalog_series->getSeriesOnce($series_id);
					$manufacturer_info['seo_title'] = $series_info['seo_title'];
					$manufacturer_info['meta_description'] = $series_info['meta_description'];
					$manufacturer_info['meta_keyword'] = $series_info['meta_keyword'];
				}
			]]></add>
		</operation>

		<operation>
			<search position="before"><![CDATA[$this->data['heading_title'] = $manufacturer_info['name'];]]></search>
			<add><![CDATA[
				if ($series_id) {
					$this->data['breadcrumbs'][] = array(
		       			'text'      => $series_info['name'],
						'href'      => $this->url->link('product/manufacturer/info', 'manufacturer_id=' . $this->request->get['manufacturer_id']  . '&series_id=' . $series_id . $url),
		      			'separator' => $this->language->get('text_separator')
		   			);
	   			}
			]]></add>
		</operation>

		<operation>
			<search position="before" index="2"><![CDATA[$this->data['text_empty'] = $this->language->get('text_empty');]]></search>
			<add><![CDATA[
				if ($series_id) {
					$this->data['title'] = $series_info['seo_h1'];
					$this->data['description'] = html_entity_decode($series_info['description'], ENT_QUOTES, 'UTF-8');
					$this->data['heading_title'] = $series_info['name'];
					if ($series_info['image']) {
						$this->data['thumb'] = $this->model_tool_image->resize($series_info['image'], $this->config->get('config_image_category_width'), $this->config->get('config_image_category_height'));
					} else {
						$this->data['thumb'] = '';
					}
				} else {
					$this->data['description'] = '';
					$this->data['thumb'] = '';
				}
			]]></add>
		</operation>

		<operation>
			<search position="after"><![CDATA['filter_manufacturer_id' => $manufacturer_id,]]></search>
			<add><![CDATA[
				'filter_series_id' => $series_id,
			]]></add>
		</operation>

		<operation>
			<search position="before" index="1"><![CDATA[$product_total = $this->model_catalog_product->getTotalProducts($data);]]></search>
			<add><![CDATA[

				$this->data['series'] = array();

				if (empty($this->request->get['series_id'])) {

					$results = $this->model_catalog_series->getSeriesByManufacturerId($manufacturer_id);

					foreach ($results as $result) {

						if (!empty($result['image'])) {
							$thumb = $this->model_tool_image->resize($result['image'], 140, 140);
						} else {
							$thumb = '';
						}
						
						$this->data['series'][] = array(
							'name'      => $result['name'],
							'thumb'		=> $thumb,
							'href'		=> $this->url->link('product/manufacturer/info', 'manufacturer_id=' . $this->request->get['manufacturer_id']  . '&series_id=' . $result['series_id'] . $url)
						);	
					}
					
				}
			]]></add>
		</operation>	
	</file>

	<file name="catalog/controller/product/product.php">
		<operation>
			<search position="before"><![CDATA[$this->data['text_stock'] = $this->language->get('text_stock');]]></search>
			<add><![CDATA[
				$this->data['text_series'] = $this->language->get('text_series');
			]]></add>
		</operation>

		<operation>
			<search position="before"><![CDATA[$this->data['model'] = $product_info['model'];]]></search>
			<add><![CDATA[
				$this->load->model('catalog/series');
				$this->data['series'] = array();
				$series_info = $this->model_catalog_series->getProductSeries($this->request->get['product_id']);
				if (!empty($series_info)) {
					$this->data['series']['name'] = $series_info['name'];
					$this->data['series']['href'] = $this->url->link('product/manufacturer/info', 'manufacturer_id=' . $product_info['manufacturer_id'] . '&series_id=' . $series_info['series_id']);
				}
			]]></add>
		</operation>	
	</file>

	<file name="catalog/language/russian/product/product.php">
		<operation>
			<search position="after"><![CDATA[$_['text_stock']]]></search>
			<add><![CDATA[
				$_['text_series']        = 'Серия:';
			]]></add>
		</operation>	
	</file>
	
	<file name="catalog/language/ukrainian/product/product.php">
		<operation>
			<search position="after"><![CDATA[$_['text_stock']]]></search>
			<add><![CDATA[
				$_['text_series']        = 'Серія:';
			]]></add>
		</operation>	
	</file>

	<file name="catalog/language/english/product/product.php">
		<operation>
			<search position="after"><![CDATA[$_['text_stock']]]></search>
			<add><![CDATA[
				$_['text_series']        = 'Series:';
			]]></add>
		</operation>	
	</file>

	<file name="catalog/language/russian/product/manufacturer.php">
		<operation>
			<search position="after"><![CDATA[$_['text_limit']]]></search>
			<add><![CDATA[
				$_['text_series']        = 'Выберите серию:';
			]]></add>
		</operation>	
	</file>
	<file name="catalog/language/ukrainian/product/manufacturer.php">
		<operation>
			<search position="after"><![CDATA[$_['text_limit']]]></search>
			<add><![CDATA[
				$_['text_series']        = 'Виберіть серію:';
			]]></add>
		</operation>	
	</file>

	<file name="catalog/language/english/product/manufacturer.php">
		<operation>
			<search position="after"><![CDATA[$_['text_limit']]]></search>
			<add><![CDATA[
				$_['text_series']        = 'Select Series:';
			]]></add>
		</operation>	
	</file>

	<file name="catalog/model/catalog/product.php">
<!-- 		<operation>
			<search position="before" index="1"><![CDATA[if (!empty($data['filter_category_id'])) {]]></search>
			<add><![CDATA[
				if (!empty($data['filter_series_id'])) {
					$sql .= " LEFT JOIN " . DB_PREFIX . "product_to_series pts ON (p.product_id = pts.product_id)";
				}
			]]></add>
		</operation>	 -->

		<operation>
			<search position="before" index="1"><![CDATA[if (!empty($data['filter_manufacturer_id'])) {]]></search>
			<add><![CDATA[
				if (!empty($data['filter_series_id'])) {
					$sql .= " AND pts.series_id = '" . (int)$data['filter_series_id'] . "'";
				}
			]]></add>
		</operation>	

<!-- 		<operation>
			<search position="before" index="3"><![CDATA[if (!empty($data['filter_category_id'])) {]]></search>
			<add><![CDATA[
				if (!empty($data['filter_series_id'])) {
					$sql .= " LEFT JOIN " . DB_PREFIX . "product_to_series pts ON (p.product_id = pts.product_id)";
				}
			]]></add>
		</operation>	 -->

		<operation>
			<search position="before" index="3"><![CDATA[$query = $this->db->query($sql);]]></search>
			<add><![CDATA[
				if (!empty($data['filter_series_id'])) {
					$sql .= " AND pts.series_id = '" . (int)$data['filter_series_id'] . "'";
				}
			]]></add>
		</operation>
	</file>

	<file name="catalog/view/theme/marketshop/template/product/manufacturer_info.tpl">
		<operation>
			<search position="before"><![CDATA[<?php if ($products) { ?>]]></search>
			<add><![CDATA[
			  <?php if ($series) { ?>
			  <h2><?php echo $text_series; ?></h2>
			  <div class="category-list">
			    <?php if (count($series) <= 5) { ?>
			    <ul>
			      <?php foreach ($series as $series_once) { ?>
			      <li><a href="<?php echo $series_once['href']; ?>"><?php echo $series_once['name']; ?></a></li>
			      <?php } ?>
			    </ul>
			    <?php } else { ?>
			    <?php for ($i = 0; $i < count($series);) { ?>
			    <ul>
			      <?php $j = $i + ceil(count($series) / 4); ?>
			      <?php for (; $i < $j; $i++) { ?>
			      <?php if (isset($series[$i])) { ?>
			      <li><a href="<?php echo $series[$i]['href']; ?>"><?php echo $series[$i]['name']; ?></a></li>
			      <?php } ?>
			      <?php } ?>
			    </ul>
			    <?php } ?>
			    <?php } ?>
			  </div>
			  <?php } ?>
			]]></add>
		</operation>

		<operation>
			<search position="after"><![CDATA[<h1><?php echo $heading_title; ?></h1>]]></search>
			<add><![CDATA[
			  <?php if ($thumb || $description) { ?>
			  <div class="category-info">
			    <?php if ($thumb) { ?>
			    <div class="image"><img src="<?php echo $thumb; ?>" alt="<?php echo $heading_title; ?>" /></div>
			    <?php } ?>
			    <?php if ($description) { ?>
			    <?php echo $description; ?>
			    <?php } ?>
			  </div>
			  <?php } ?>
			]]></add>
		</operation>	
	</file>
</modification>